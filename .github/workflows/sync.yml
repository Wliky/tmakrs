# ==============================================================================
# ã€é€šç”¨æ¨¡æ¿ã€‘Fork ä»“åº“è‡ªåŠ¨åŒæ­¥ + TG ç»“æœé€šçŸ¥ï¼ˆè°ƒç”¨ç»Ÿä¸€æ¨¡æ¿ï¼‰
# åŠŸèƒ½ï¼š1. å®šæ—¶/æ‰‹åŠ¨åŒæ­¥ Fork ä»“åº“ä¸ä¸Šæ¸¸ 2. åŒæ­¥ç»“æœè°ƒç”¨ TG æ¨¡æ¿æ¨é€
# é€‚é…åœºæ™¯ï¼šæ‰€æœ‰ Fork ä»“åº“çš„è‡ªåŠ¨åŒæ­¥éœ€æ±‚ï¼Œæ— éœ€é‡å¤ç¼–å†™ TG æ¨é€é€»è¾‘
# é…ç½®é¡¹ï¼šä»…éœ€ä¿®æ”¹ UPSTREAM_REPO ä¸ºå®é™…ä¸Šæ¸¸ä»“åº“åœ°å€
# ==============================================================================
name: Fork Sync + TG Notify (Universal)

# æƒé™é…ç½®ï¼šåŒæ­¥ä»£ç éœ€è¦å†™å…¥æƒé™ï¼Œè°ƒç”¨æ¨¡æ¿éœ€è¦è¯»å–æƒé™
permissions:
  contents: write  # æ¨é€åŒæ­¥åçš„ä»£ç åˆ° Fork ä»“åº“
  actions: read    # è°ƒç”¨å¤–éƒ¨æ¨¡æ¿ä»“åº“çš„å·¥ä½œæµ

# è§¦å‘æ¡ä»¶ï¼šå®šæ—¶æ‰§è¡Œ + æ‰‹åŠ¨è§¦å‘ï¼ˆå…¼é¡¾è‡ªåŠ¨/æ‰‹åŠ¨éœ€æ±‚ï¼‰
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 8 ç‚¹ï¼‰æ‰§è¡Œï¼Œå¯ä¿®æ”¹ cron è¡¨è¾¾å¼
  schedule:
    - cron: "0 0 * * *"
  # æ‰‹åŠ¨è§¦å‘ï¼šæ”¯æŒè‡ªå®šä¹‰åŒæ­¥åˆ†æ”¯ï¼Œé€‚é…ä¸´æ—¶åŒæ­¥éœ€æ±‚
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Fork ä»“åº“ç›®æ ‡åŒæ­¥åˆ†æ”¯'
        required: false
        default: 'main'
      upstream_branch:
        description: 'ä¸Šæ¸¸ä»“åº“æºåˆ†æ”¯'
        required: false
        default: 'main'

# å…¨å±€å¸¸é‡ï¼ˆé›†ä¸­ç®¡ç†ï¼Œä¾¿äºä¿®æ”¹ï¼‰
env:
  # ã€å¿…æ”¹é¡¹ã€‘æ›¿æ¢ä¸ºä½ çš„ä¸Šæ¸¸ä»“åº“åœ°å€ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“åï¼‰
  UPSTREAM_REPO: "ai-tmarks/tmarks"

jobs:
  # ä»»åŠ¡1ï¼šæ‰§è¡Œ Fork ä»“åº“åŒæ­¥
  sync-fork-with-upstream:
    name: Sync Fork Repository
    runs-on: ubuntu-latest
    # ä»…å½“å½“å‰ä»“åº“æ˜¯ Fork ä»“åº“æ—¶æ‰§è¡Œï¼ˆé¿å…é Fork ä»“åº“è¯¯è§¦å‘ï¼‰
    if: ${{ github.event.repository.fork }}
    # è¾“å‡ºåŒæ­¥ç»“æœï¼Œä¾› TG é€šçŸ¥æ­¥éª¤ä½¿ç”¨
    outputs:
      sync_status: ${{ steps.check-sync-result.outputs.status }}
      sync_message: ${{ steps.check-sync-result.outputs.message }}
      repo_name: ${{ github.repository }}
      target_branch: ${{ github.event.inputs.target_branch || 'main' }}

    steps:
      - name: Checkout Fork Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # GitHub è‡ªåŠ¨ç”Ÿæˆçš„ä¸´æ—¶ä»¤ç‰Œ
          fetch-depth: 0                      # æ‹‰å–å®Œæ•´æäº¤å†å²ï¼Œç¡®ä¿åŒæ­¥å®Œæ•´

      - name: Sync with Upstream Repository
        id: sync-step
        continue-on-error: true  # åŒæ­¥å¤±è´¥ä¸ç»ˆæ­¢ï¼Œç»§ç»­æ‰§è¡Œé€šçŸ¥æ­¥éª¤
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          upstream_sync_repo: ${{ env.UPSTREAM_REPO }}
          upstream_sync_branch: ${{ github.event.inputs.upstream_branch }}
          target_sync_branch: ${{ github.event.inputs.target_branch }}
          test_mode: false  # ç”Ÿäº§ç¯å¢ƒè®¾ä¸º falseï¼Œæµ‹è¯•æ—¶å¯è®¾ä¸º trueï¼ˆä»…æ¨¡æ‹Ÿä¸æ¨é€ï¼‰

      - name: Check Sync Result
        id: check-sync-result
        run: |
          # åˆ¤æ–­åŒæ­¥ç»“æœï¼Œç”Ÿæˆæ ‡å‡†åŒ–æ¶ˆæ¯
          if [ "${{ steps.sync-step.outcome }}" = "success" ]; then
            echo "status=æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "message=ä»“åº“ã€${{ github.repository }}ã€‘åˆ†æ”¯ã€${{ github.event.inputs.target_branch || 'main' }}ã€‘åŒæ­¥ä¸Šæ¸¸æˆåŠŸï¼" >> $GITHUB_OUTPUT
            echo "âœ… Fork åŒæ­¥å®Œæˆ"
          else
            echo "status=å¤±è´¥" >> $GITHUB_OUTPUT
            echo "message=ä»“åº“ã€${{ github.repository }}ã€‘åˆ†æ”¯ã€${{ github.event.inputs.target_branch || 'main' }}ã€‘åŒæ­¥ä¸Šæ¸¸å¤±è´¥ï¼å¯èƒ½åŸå› ï¼š1.åˆå¹¶å†²çª 2.ä¸Šæ¸¸ä»“åº“åœ°å€é”™è¯¯ 3.ç½‘ç»œé—®é¢˜" >> $GITHUB_OUTPUT
            echo "âŒ Fork åŒæ­¥å¤±è´¥"
          fi

  # ä»»åŠ¡2ï¼šè°ƒç”¨ TG æ¨¡æ¿æ¨é€åŒæ­¥ç»“æœ
  send-tg-notification:
    name: Send Sync Result to TG
    runs-on: ubuntu-latest
    needs: sync-fork-with-upstream  # ä¾èµ–åŒæ­¥ä»»åŠ¡å®Œæˆ
    steps:
      - name: Call Reusable TG Template
        # ã€å¿…æ”¹é¡¹ã€‘æ›¿æ¢ä¸ºä½ çš„æ¨¡æ¿ä»“åº“åœ°å€ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/æ¨¡æ¿ä»“åº“å@åˆ†æ”¯ï¼‰
        uses: "Wliky/pusher/.github/workflows/telegram.yml@main"
        with:
          # åŠ¨æ€ç”Ÿæˆé€šçŸ¥æ ‡é¢˜ï¼ˆåŒ…å«åŒæ­¥çŠ¶æ€ï¼‰
          notify_title: "ğŸ”„ Forkä»“åº“åŒæ­¥${{ needs.sync-fork-with-upstream.outputs.sync_status }}"
          # åŠ¨æ€ç”Ÿæˆé€šçŸ¥å†…å®¹ï¼ˆåŒ…å«ä»“åº“ä¿¡æ¯+é“¾æ¥ï¼‰
          notify_content: |
            ${{ needs.sync-fork-with-upstream.outputs.sync_message }}
            ğŸ”— ä»“åº“åœ°å€ï¼šhttps://github.com/${{ needs.sync-fork-with-upstream.outputs.repo_name }}
            ğŸŒ¿ åŒæ­¥åˆ†æ”¯ï¼š${{ needs.sync-fork-with-upstream.outputs.target_branch }}
